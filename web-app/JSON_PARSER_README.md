# JSON Parser - Автоматический парсинг JSON и заполнение HTML полей

## Описание

Система автоматически парсит JSON-ответы от backend и заполняет соответствующие HTML поля на страницах приложения.

## Файлы

- `json-parser.js` - Основной скрипт для парсинга JSON и заполнения HTML полей
- `dom-updater.js` - Утилиты для обновления DOM элементов
- `api.js` - API для работы с backend

## Как это работает

### Автоматическая загрузка

При загрузке страницы автоматически:

1. Проверяется, авторизован ли пользователь
2. Загружается профиль пользователя и заполняются поля:
   - `.student-name` - Имя пользователя
   - `.student-email` - Email пользователя
   - `#userId` - ID пользователя

3. На страницах с чатами загружается список чатов
4. На страницах с сообщениями загружаются сообщения чата

### Ручное использование

#### Парсинг и заполнение профиля пользователя

```javascript
// Автоматическое определение типа данных
const profileData = {
    name: "Иван Иванов",
    email: "ivan@urfu.ru",
    id: "12345",
    group: "ИСП-21"
};

JSONParser.parseAndFill(profileData, 'profile');

// Или вручную
JSONParser.fillUserProfile(profileData);
```

#### Загрузка и заполнение профиля с backend

```javascript
// Автоматически загружает с backend и заполняет HTML
await JSONParser.loadAndFillProfile();
```

#### Парсинг и заполнение списка чатов

```javascript
const chatsData = [
    {
        id: "chat-1",
        title: "Чат 1",
        lastMessage: "Привет!",
        lastMessageDate: "2024-01-15T10:00:00Z"
    },
    {
        id: "chat-2",
        title: "Чат 2",
        lastMessage: "Как дела?",
        lastMessageDate: "2024-01-15T09:00:00Z"
    }
];

JSONParser.parseAndFill(chatsData, 'chats');

// Или вручную
JSONParser.fillChatsList(chatsData);
```

#### Загрузка и заполнение чатов с backend

```javascript
// Автоматически загружает с backend и заполняет HTML
await JSONParser.loadAndFillChats();
```

#### Парсинг и заполнение сообщений

```javascript
const messagesData = [
    {
        text: "Привет!",
        isUser: true
    },
    {
        text: "Здравствуйте! Чем могу помочь?",
        isUser: false
    }
];

JSONParser.parseAndFill(messagesData, 'messages');

// Или вручную
JSONParser.fillChatMessages(messagesData);
```

#### Загрузка и заполнение сообщений с backend

```javascript
// Автоматически загружает с backend и заполняет HTML
await JSONParser.loadAndFillMessages('chat-id-123');
```

#### Парсинг и заполнение курсов

```javascript
const coursesData = [
    {
        id: "course-1",
        name: "Веб-разработка",
        type: "Курс"
    },
    {
        id: "course-2",
        name: "Базы данных",
        type: "Курс"
    }
];

JSONParser.parseAndFill(coursesData, 'courses');

// Или вручную
JSONParser.fillCourses(coursesData);
```

## Интеграция с backend API

### Автоматическая интеграция

Скрипт автоматически интегрируется с `api.js`:

- При загрузке страницы проверяется авторизация через `API.isAuthenticated()`
- Профиль загружается через `API.getUserProfile()`
- Чаты загружаются через `API.getAllChats()`
- Сообщения загружаются через `API.getChatMessages(chatId)`

### В chat-neiro.js

Чат с нейронкой автоматически использует парсер:

1. При отправке сообщения оно отправляется на backend через `API.sendMessageToNewChat()` или `API.sendMessageToChat()`
2. Ответы приходят через Server-Sent Events (SSE)
3. JSON данные автоматически парсятся и отображаются в чате
4. История сообщений автоматически загружается при открытии чата

## Что автоматически обновляется

### Профиль пользователя
- Имя в `.student-name` (во всех HTML файлах)
- Email в `.student-email` (во всех HTML файлах)
- ID в `#userId`
- Группа в `[data-user-group]`
- Университет в `[data-user-university]`

### Список чатов
- Создаются карточки чатов в `.courses-grid` или `#chatsList`
- Каждая карточка содержит:
  - Название чата
  - Последнее сообщение
  - Время последнего сообщения
  - Обработчик клика для открытия чата

### Сообщения чата
- Создаются элементы сообщений в `#chatMessages` или `.chat-messages`
- Сообщения пользователя отображаются справа (оранжевые)
- Сообщения бота отображаются слева (серые)
- К сообщениям бота добавляется кнопка копирования

### Курсы
- Создаются карточки курсов в `.courses-grid`
- Каждая карточка содержит:
  - Тип курса
  - Название курса

## Формат JSON данных

### Профиль пользователя

```json
{
    "name": "Иван Иванов",
    "email": "ivan@urfu.ru",
    "id": "12345",
    "userId": "12345",
    "studentId": "12345",
    "group": "ИСП-21",
    "groupName": "ИСП-21",
    "university": "УрФУ",
    "universityName": "УрФУ"
}
```

### Список чатов

```json
[
    {
        "id": "chat-1",
        "chatId": "chat-1",
        "title": "Чат 1",
        "name": "Чат 1",
        "lastMessage": "Привет!",
        "preview": "Привет!",
        "lastMessageDate": "2024-01-15T10:00:00Z",
        "updatedAt": "2024-01-15T10:00:00Z",
        "date": "2024-01-15T10:00:00Z"
    }
]
```

### Сообщения чата

```json
[
    {
        "text": "Привет!",
        "content": "Привет!",
        "message": "Привет!",
        "isUser": true
    },
    {
        "text": "Здравствуйте!",
        "content": "Здравствуйте!",
        "message": "Здравствуйте!",
        "isUser": false
    }
]
```

### Курсы

```json
[
    {
        "id": "course-1",
        "courseId": "course-1",
        "name": "Веб-разработка",
        "courseName": "Веб-разработка",
        "title": "Веб-разработка",
        "type": "Курс"
    }
]
```

## Логирование

Все операции логируются в консоль с префиксом `[JSON Parser]`:

```javascript
[JSON Parser] DOM загружен, начало автоматической загрузки данных...
[JSON Parser] Пользователь авторизован, загружаем данные...
[JSON Parser] Загрузка профиля с backend...
[JSON Parser] Профиль получен: {...}
[JSON Parser] Заполнение профиля пользователя: {...}
[JSON Parser] Имя пользователя обновлено: Иван Иванов
[JSON Parser] Email пользователя обновлен: ivan@urfu.ru
[JSON Parser] Профиль заполнен
```

## Подключение на страницах

Скрипт автоматически подключается на всех страницах:

```html
<script src="api.js"></script>
<script src="dom-updater.js"></script>
<script src="json-parser.js"></script>
```

Порядок подключения важен:
1. `api.js` - API для работы с backend
2. `dom-updater.js` - Утилиты для обновления DOM
3. `json-parser.js` - Парсер JSON и заполнение HTML

## Примеры использования

### Пример 1: Автоматическая загрузка при загрузке страницы

При открытии страницы автоматически:
- Загружается профиль пользователя
- Заполняются поля `.student-name` и `.student-email`

### Пример 2: Загрузка чатов при открытии страницы с чатами

При открытии страницы с чатами автоматически:
- Загружается список чатов с backend
- Создаются карточки чатов
- Каждая карточка содержит название, последнее сообщение и время

### Пример 3: Отправка сообщения в чат

При отправке сообщения в чат:
- Сообщение отправляется на backend через API
- Подключается SSE для получения ответа в реальном времени
- JSON ответы автоматически парсятся и отображаются в чате

## Отладка

Для отладки проверьте консоль браузера (F12):

1. Убедитесь, что API подключен: `window.API` должен быть определен
2. Убедитесь, что парсер подключен: `window.JSONParser` должен быть определен
3. Проверьте логи: все операции логируются с префиксом `[JSON Parser]`
4. Проверьте сетевые запросы: вкладка Network показывает запросы к backend

## Ошибки

Если данные не заполняются:

1. Проверьте авторизацию: `API.isAuthenticated()` должен возвращать `true`
2. Проверьте формат JSON: данные должны соответствовать ожидаемому формату
3. Проверьте консоль: ошибки будут показаны с префиксом `[JSON Parser]`
4. Проверьте наличие элементов: элементы с соответствующими селекторами должны существовать на странице

